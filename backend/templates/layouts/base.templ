package layouts

import "strings"

// userInitials returns the initials from a name (max 2 chars)
func userInitials(name string) string {
	if name == "" {
		return "?"
	}
	parts := strings.Fields(name)
	if len(parts) == 0 {
		return string(name[0])
	}
	if len(parts) == 1 {
		return strings.ToUpper(string(parts[0][0]))
	}
	return strings.ToUpper(string(parts[0][0]) + string(parts[len(parts)-1][0]))
}

// roleLabel returns Indonesian label for role
func roleLabel(role string) string {
	switch role {
	case "admin":
		return "Administrator"
	case "supervisor":
		return "Supervisor"
	case "consultant":
		return "Konsultan"
	default:
		return role
	}
}

// PageData contains common data for all pages
// Note: CSRF protection uses Go 1.25's http.CrossOriginProtection (header-based)
// No token fields needed - uses Sec-Fetch-Site and Origin headers
type PageData struct {
	Title    string
	Version  string
	UserName string
	UserRole string
}

templ Base(data PageData) {
	<!DOCTYPE html>
	<html lang="id">
		<head>
			<meta charset="UTF-8"/>
			<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
			<title>{ data.Title } - STMIK Tazkia</title>
			<link rel="stylesheet" href="/static/css/output.css"/>
			<script src="/static/js/htmx.min.js" defer></script>
			<script src="/static/js/alpine-csp.min.js" defer></script>
		</head>
		<body class="bg-gray-50 min-h-screen">
			{ children... }
		</body>
	</html>
}

templ Portal(data PageData) {
	@Base(data) {
		<div class="min-h-screen flex flex-col">
			<header class="bg-primary-900 text-white shadow-md" data-testid="portal-header">
				<div class="container mx-auto px-4 py-4 flex items-center justify-between">
					<a href="/portal" class="text-xl font-bold" data-testid="portal-logo">STMIK Tazkia</a>
					<nav class="flex items-center gap-4" data-testid="portal-nav">
						<a href="/portal" class="hover:text-secondary-400" data-testid="nav-dashboard">Dashboard</a>
						<a href="/portal/application" class="hover:text-secondary-400" data-testid="nav-application">Pendaftaran</a>
						<a href="/portal/documents" class="hover:text-secondary-400" data-testid="nav-documents">Dokumen</a>
						<form action="/portal/logout" method="POST" class="inline">
							<button type="submit" class="hover:text-secondary-400" data-testid="btn-logout">Logout</button>
						</form>
					</nav>
				</div>
			</header>
			<main class="flex-1 container mx-auto px-4 py-8" data-testid="portal-main">
				{ children... }
			</main>
			<footer class="bg-gray-100 border-t" data-testid="portal-footer">
				<div class="container mx-auto px-4 py-4 flex items-center justify-between text-gray-600 text-sm">
					<span>&copy; 2025 STMIK Tazkia. All rights reserved.</span>
					<span class="text-gray-400 font-mono text-xs" title="Git commit hash for bug reports" data-testid="version-info">{ data.Version }</span>
				</div>
			</footer>
		</div>
	}
}

templ Admin(data PageData) {
	@Base(data) {
		<div class="min-h-screen flex">
			<!-- Sidebar -->
			<aside class="w-64 bg-primary-900 text-white relative flex-shrink-0" data-testid="admin-sidebar">
				<div class="p-4 border-b border-primary-800">
					<a href="/admin" class="text-xl font-bold" data-testid="admin-logo">PMB Admin</a>
					<p class="text-primary-300 text-sm mt-1">STMIK Tazkia</p>
				</div>
				<nav class="mt-2 overflow-y-auto" style="max-height: calc(100vh - 180px);" data-testid="admin-nav">
					<a href="/admin" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-dashboard">
						<span class="mr-2">ğŸ“Š</span> Dashboard
					</a>
					<a href="/admin/my-dashboard" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-my-dashboard">
						<span class="mr-2">ğŸ </span> Dashboard Saya
					</a>
					<a href="/admin/candidates" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-candidates">
						<span class="mr-2">ğŸ‘¥</span> Kandidat
					</a>
					<a href="/admin/documents" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-documents">
						<span class="mr-2">ğŸ“„</span> Review Dokumen
					</a>
					<div class="px-4 py-2 text-primary-400 text-xs uppercase tracking-wider mt-4">Marketing</div>
					<a href="/admin/campaigns" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-campaigns">
						<span class="mr-2">ğŸ“¢</span> Kampanye
					</a>
					<a href="/admin/referrers" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-referrers">
						<span class="mr-2">ğŸ¤</span> Referrer
					</a>
					<a href="/admin/referral-claims" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-claims">
						<span class="mr-2">ğŸ”</span> Klaim Referral
					</a>
					<a href="/admin/commissions" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-commissions">
						<span class="mr-2">ğŸ’°</span> Komisi
					</a>
					<div class="px-4 py-2 text-primary-400 text-xs uppercase tracking-wider mt-4">Reports</div>
					<a href="/admin/reports/funnel" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-funnel">
						<span class="mr-2">ğŸ“ˆ</span> Funnel
					</a>
					<a href="/admin/reports/consultants" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-consultants">
						<span class="mr-2">ğŸ‘¤</span> Performa Konsultan
					</a>
					<a href="/admin/reports/campaigns" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-campaign-roi">
						<span class="mr-2">ğŸ“Š</span> ROI Kampanye
					</a>
					<div class="px-4 py-2 text-primary-400 text-xs uppercase tracking-wider mt-4">Settings</div>
					<a href="/admin/settings/users" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-users">
						<span class="mr-2">ğŸ‘¤</span> Users
					</a>
					<a href="/admin/settings/programs" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-programs">
						<span class="mr-2">ğŸ“</span> Prodi
					</a>
					<a href="/admin/settings/fees" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-fees">
						<span class="mr-2">ğŸ’µ</span> Biaya
					</a>
					<a href="/admin/settings/rewards" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-rewards">
						<span class="mr-2">ğŸ</span> Reward
					</a>
					<a href="/admin/settings/categories" class="block px-4 py-2 hover:bg-primary-800" data-testid="nav-categories">
						<span class="mr-2">ğŸ·ï¸</span> Kategori
					</a>
				</nav>
				<div class="absolute bottom-0 w-64 p-4 border-t border-primary-800 bg-primary-900">
					<div class="flex items-center gap-2 mb-2">
						<span class="w-8 h-8 bg-primary-700 rounded-full flex items-center justify-center text-sm" data-testid="user-avatar">{ userInitials(data.UserName) }</span>
						<div class="text-sm">
							<p class="font-medium" data-testid="user-name">{ data.UserName }</p>
							<p class="text-primary-400 text-xs" data-testid="user-role">{ roleLabel(data.UserRole) }</p>
						</div>
					</div>
					<form action="/admin/logout" method="POST" class="inline">
						<button type="submit" class="block text-sm hover:text-secondary-400" data-testid="btn-logout">Logout</button>
					</form>
					<span class="block mt-2 text-primary-400 font-mono text-xs" title="Git commit hash for bug reports" data-testid="version-info">{ data.Version }</span>
				</div>
			</aside>
			<!-- Main content -->
			<div class="flex-1 flex flex-col min-w-0">
				<header class="bg-white shadow-sm border-b px-6 py-4" data-testid="admin-header">
					<h1 class="text-xl font-semibold text-gray-800" data-testid="page-title">{ data.Title }</h1>
				</header>
				<main class="flex-1 p-6 bg-gray-50 overflow-auto" data-testid="admin-main">
					{ children... }
				</main>
			</div>
		</div>
	}
}

templ Auth(data PageData) {
	@Base(data) {
		<div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-primary-50 to-secondary-50" data-testid="auth-container">
			<div class="w-full max-w-md" data-testid="auth-form-container">
				{ children... }
			</div>
			<div class="mt-8 text-gray-400 font-mono text-xs" title="Git commit hash for bug reports" data-testid="version-info">
				{ data.Version }
			</div>
		</div>
	}
}
